// Last edited by deforce on 03-17-2008
string query_random_limb();
object query_weapons();
object query_target();
object get_target();
void add_event(object target, object weapon, mixed target_extra, mixed data);
int badly_wounded();
int panic();
varargs void stop_fight(object);
int check_condition(int);
void simple_action(string);
int query_ghost();
void target_is_asleep();
void handle_events();

void take_a_swing(object target)
{
   foreach (object weapon in query_weapons())
   {
      for (int count = 0; count < weapon->query_weapon_speed(); count ++)
      {
         if (query_ghost() || !(target = get_target()))
         {
            stop_fight();
            return;
         }

         if (random(101) > 95)
         {
            add_event(target, weapon, query_random_limb(), "miss");
         }
         else
         {
            add_event(target, weapon, query_random_limb(), random(weapon->query_weapon_class() + 1));
         }
      }
   }
}

void attack()
{
   object target;
   mixed tmp;

   // check whether we are capable of attacking
   if (tmp = check_condition(1))
   {
      if (tmp[<1] == '\n') { write(tmp); }
      else { simple_action(tmp + " so $p blows are ineffective."); }

      return;
   }

   target = get_target();

   // Any reason to continue the carnage?
   if (query_ghost() || !target)
   {
      stop_fight();
      return;
   }

   if (target->query_asleep())
   {
      // Our target is unconcious. We get to have our way with them *evil grin*
      target_is_asleep();
      return;
   }

   take_a_swing(target);
   handle_events();
}